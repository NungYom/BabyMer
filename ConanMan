--============================--
-- SERVICES
--============================--
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local lp = Players.LocalPlayer

--============================--
-- REMOTES (KNIT)
--============================--
local Knit = ReplicatedStorage
    :WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_knit@1.4.7")
    :WaitForChild("knit")
    :WaitForChild("Services")

local ProjectileRemote = Knit:WaitForChild("ProjectileService"):WaitForChild("RF"):WaitForChild("FireToOthers")
local AudioRemote = Knit:WaitForChild("AudioPlaybackService"):WaitForChild("RF"):WaitForChild("PlayFromClient")
local DamageRemote = Knit:WaitForChild("DamageService"):WaitForChild("RF"):WaitForChild("HandleHit")

--============================--
-- GUI
--============================--
local gui = Instance.new("ScreenGui")
gui.ResetOnSpawn = false
gui.Parent = lp:WaitForChild("PlayerGui")

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 260, 0, 55)
button.Position = UDim2.new(0, 20, 0, 200)
button.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
button.TextColor3 = Color3.new(1, 1, 1)
button.TextScaled = true
button.Text = "Ranged + Timer Loot : OFF"
button.Parent = gui

--============================--
-- STATE & TIMERS
--============================--
local running = false
local floatForce
local noclipConnection
local lootTimers = {} -- เก็บข้อมูลเวลาความปลอดภัยของถุงแต่ละใบ

--============================--
-- HELPERS
--============================--
local function getTool()
    if lp.Character then
        for _, v in pairs(lp.Character:GetChildren()) do
            if v:IsA("Tool") then return v end
        end
    end
end

local function getClosestEnemy()
    local gameFolder = workspace:FindFirstChild("Game")
    local enemies = gameFolder and gameFolder:FindFirstChild("Enemies")
    if not enemies then return end
    
    local char = lp.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end

    local myPos = char.HumanoidRootPart.Position
    local closest, shortest = nil, math.huge

    for _, enemy in pairs(enemies:GetChildren()) do
        if enemy:FindFirstChild("HumanoidRootPart") 
        and enemy:FindFirstChild("Humanoid") 
        and enemy.Humanoid.Health > 0 then
            local dist = (enemy.HumanoidRootPart.Position - myPos).Magnitude
            if dist < shortest then
                shortest = dist
                closest = enemy
            end
        end
    end
    return closest
end

-- ตรวจสอบว่ารอบๆ ตำแหน่งที่กำหนด มีศัตรูอยู่หรือไม่
local function isAreaSafe(position, radius)
    local gameFolder = workspace:FindFirstChild("Game")
    local enemies = gameFolder and gameFolder:FindFirstChild("Enemies")
    if not enemies then return true end

    for _, enemy in pairs(enemies:GetChildren()) do
        local enemyRoot = enemy:FindFirstChild("HumanoidRootPart")
        local hum = enemy:FindFirstChild("Humanoid")
        if enemyRoot and hum and hum.Health > 0 then
            if (enemyRoot.Position - position).Magnitude <= radius then
                return false
            end
        end
    end
    return true
end

-- ฟังก์ชันหา Lootbag ที่ปลอดภัยติดต่อกันเกิน 5 วินาที
local function getClosestTimedSafeLoot()
    local gameFolder = workspace:FindFirstChild("Game")
    local debris = gameFolder and gameFolder:FindFirstChild("Debris")
    if not debris then return end

    local char = lp.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end

    local myPos = char.HumanoidRootPart.Position
    local currentTime = tick()
    local closestLoot, shortestDist = nil, math.huge

    for _, bag in pairs(debris:GetChildren()) do
        if bag.Name == "Lootbag" then
            local mesh = bag:FindFirstChild("Meshes/LootsackLP")
            if mesh and mesh:IsA("BasePart") then
                -- เช็คว่าปัจจุบันปลอดภัยไหม
                if isAreaSafe(mesh.Position, 15) then
                    -- ถ้าปลอดภัย ให้เริ่มจับเวลา (ถ้ายังไม่มีใน Table)
                    if not lootTimers[bag] then
                        lootTimers[bag] = currentTime
                    end
                    
                    -- เช็คว่าปลอดภัยมานานเกิน 5 วินาทีหรือยัง
                    if (currentTime - lootTimers[bag]) >= 5 then
                        local dist = (mesh.Position - myPos).Magnitude
                        if dist < shortestDist then
                            shortestDist = dist
                            closestLoot = mesh
                        end
                    end
                else
                    -- ถ้าไม่ปลอดภัย (มีศัตรูในระยะ 15) ให้รีเซ็ตเวลาใหม่
                    lootTimers[bag] = nil
                end
            end
        end
    end

    -- Cleanup: ลบข้อมูลถุงที่ถูกลบออกจากเกมไปแล้วออกจาก Table
    for bag, _ in pairs(lootTimers) do
        if not bag or not bag.Parent then
            lootTimers[bag] = nil
        end
    end

    return closestLoot
end

--============================--
-- SYSTEMS (FLOAT & NOCLIP)
--============================--
local function enableFloat()
    local char = lp.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    floatForce = Instance.new("BodyVelocity")
    floatForce.Velocity = Vector3.new(0, 0, 0)
    floatForce.MaxForce = Vector3.new(0, math.huge, 0)
    floatForce.Parent = char.HumanoidRootPart
end

local function disableFloat()
    if floatForce then floatForce:Destroy() floatForce = nil end
end

local function enableNoclip()
    noclipConnection = RunService.Stepped:Connect(function()
        if lp.Character then
            for _, v in pairs(lp.Character:GetDescendants()) do
                if v:IsA("BasePart") then v.CanCollide = false end
            end
        end
    end)
end

local function disableNoclip()
    if noclipConnection then noclipConnection:Disconnect() noclipConnection = nil end
end

--============================--
-- MAIN LOOP
--============================--
task.spawn(function()
    while true do
        if running then
            local char = lp.Character
            local root = char and char:FindFirstChild("HumanoidRootPart")
            
            if root then
                -- 1. หาถุงที่ปลอดภัยเกิน 5 วินาที
                local lootMesh = getClosestTimedSafeLoot()
                
                if lootMesh then
                    root.CFrame = lootMesh.CFrame
                    task.wait(0.3) -- เพิ่มเวลาหยุดรอเก็บเล็กน้อย
                else
                    -- 2. ถ้าไม่มีถุงที่พร้อมเก็บ ให้ยิงศัตรูต่อ
                    local tool = getTool()
                    local enemy = getClosestEnemy()

                    if tool and enemy and enemy:FindFirstChild("HumanoidRootPart") then
                        local myPos = root.Position
                        local enemyPos = enemy.HumanoidRootPart.Position
                        local fireTime = DateTime.now().UnixTimestampMillis / 1000
                        local weaponId = tool.Name
                        local weaponKey = tool:GetAttribute("Key")

                        root.CFrame = CFrame.new(enemyPos + Vector3.new(0, 30, 0))

                        pcall(function()
                            ProjectileRemote:InvokeServer(
                                Vector3.new(myPos.X, myPos.Y, myPos.Z),
                                Vector3.new(enemyPos.X, enemyPos.Y, enemyPos.Z),
                                weaponId, 0, fireTime
                            )
                            AudioRemote:InvokeServer(Vector3.new(myPos.X, myPos.Y, myPos.Z), "WeaponRangedAttack")
                            
                            DamageRemote:InvokeServer({
                                IsEnemyBlocking = false,
                                Type = "PlayerToEnemyRanged",
                                EnemyId = enemy.Name,
                                WeaponId = weaponId,
                                FireTime = fireTime,
                                IsHeavy = false,
                                TargetItem = enemy:FindFirstChild("Humanoid"),
                                WeaponKey = weaponKey,
                                Position = Vector3.new(myPos.X, myPos.Y, myPos.Z)
                            }, Vector3.new(myPos.X, myPos.Y, myPos.Z))

                            AudioRemote:InvokeServer(Vector3.new(myPos.X, myPos.Y, myPos.Z), "WeaponRangedReload")
                        end)
                    end
                end
            end
        end
        task.wait(0.1)
    end
end)

--============================--
-- TOGGLE EVENT
--============================--
button.MouseButton1Click:Connect(function()
    running = not running
    if running then
        button.Text = "Ranged + Timer Loot : ON"
        button.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        enableFloat()
        enableNoclip()
    else
        button.Text = "Ranged + Timer Loot : OFF"
        button.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
        disableFloat()
        disableNoclip()
        table.clear(lootTimers) -- ล้างเวลาเมื่อปิด
    end
end)
